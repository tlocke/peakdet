<!DOCTYPE html>
<html>
  <head>
    <title>PeakDet</title>
    <meta charset="utf-8">
    <script src="bower_components/papaparse/papaparse.js"></script>
    <script src="bower_components/chartist/dist/chartist.js"></script>
    <script src="peakdet.js"></script>
    <link
      rel="stylesheet"
      href="bower_components/chartist/dist/chartist.min.css">
  </head>
  <body>
    <h1>Peak Detector</h1>

    <p>
      Load in a CSV file with a single column of figures, using the button
      below. Then a graph of the data and all the peaks (in yellow) and the
      valleys (in pink) will be displayed. The sensitivity is controlled by
      the value of the minimum peak height. The lower the minimum height, the
      higher the number of peaks. There's an
      <a href="example.csv">example CSV file</a> that you can use to try it
      out if you haven't got any suitable data to hand.
    </p>

    <input type="file" id="file">
    Minimum height:
    <input id="min_height" value="0.5">
    <input type="button" value="Calculate" onclick="calc()">
    <div class="ct-chart ct-octave" id="chart1"></div>
    <pre id="debug"></pre>

    <script>
      var v;
      var labs;

      dbge = document.getElementById("debug");

      function handleFileSelect(evt) {
        var file = evt.target.files[0];
        papaConf = {
          complete: loaded,
          skipEmptyLines: true,
          header: false}
        Papa.parse(file, papaConf);
      }

      function calc() {
        min_height_field = document.getElementById("min_height");
        min_height = parseFloat(min_height_field.value)
        res = peakdet(v, min_height);
        var pks = []
        var vls = []
        for (var i = 0; i < v.length; i++) {
          pks.push(null)
          vls.push(null)
        }
        //var rdbg = res.debug;
        //dbge.innerHTML = rdbg;
        peaks = res.peaks
        if (peaks.length == 0) {
          console.log(
            "No peaks detected. The minimum peak height is " + min_height)
        }
        valleys = res.valleys
        for (var i=0; i < peaks.length; i++) {
          peak = peaks[i]
          pks[peak.position] = peak.value
        }
        for (var i=0; i < valleys.length; i++) {
          valley = valleys[i]
          vls[valley.position] = valley.value
        }
        cdata = {
          labels: labs,
          series: [v, vls, pks]
        };
        new Chartist.Line('#chart1', cdata);
      }

      function loaded(results) {
        errors = results.errors
        for (var i = 0; i < errors.length; i++) {
          console.log(errors[i])
        }
        v = []
        labs = []
        data = results.data
        for (var u = 0; u < data.length; u++) {
          line = data[u]
          val = parseFloat(line[0])
          if (isNaN(val)) {
            continue;
          }
          labs.push(v.length)
          v.push(val)
        }
        v.reverse();
        calc();
      }

      document.getElementById('file').addEventListener(
        'change', handleFileSelect, false);
    </script>
  </body>
</html>
